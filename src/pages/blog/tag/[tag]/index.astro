---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getPostUrl, withBase } from '../../../../utils/blog';

const base = import.meta.env.BASE_URL;

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tagSet = new Set<string>();
  for (const post of posts) {
    for (const tag of post.data.tags) {
      tagSet.add(tag);
    }
  }
  return Array.from(tagSet).map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
const posts = (await getCollection('blog'))
  .filter((p) => !p.data.draft && p.data.tags.includes(tag!))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout title={`태그: ${tag}`} description={`${tag} 태그의 글 목록`}>
  <div class="filtered-page">
    <p class="filter-label">태그: <strong>{tag}</strong></p>
    <ul class="post-list">
      {posts.map((post) => (
        <li class="post-item">
          <a href={getPostUrl(post.id, base)} class="post-title">{post.data.title}</a>
          <time datetime={post.data.pubDate.toISOString()} class="post-date">
            {post.data.pubDate.toLocaleDateString('ko-KR')}
          </time>
          <a href={withBase('/blog/', base)}>← 모든 글</a>
        </li>
      ))}
    </ul>
  </div>
</BaseLayout>
