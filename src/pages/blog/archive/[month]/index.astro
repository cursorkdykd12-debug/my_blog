---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { formatMonthKey, getPostUrl } from '../../../../utils/blog';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const monthSet = new Set<string>();
  for (const post of posts) {
    const key = `${post.data.pubDate.getFullYear()}-${String(post.data.pubDate.getMonth() + 1).padStart(2, '0')}`;
    monthSet.add(key);
  }
  return Array.from(monthSet).map((month) => ({
    params: { month },
  }));
}

const { month } = Astro.params;
const [year, monthNum] = (month ?? '').split('-').map(Number);
const posts = (await getCollection('blog'))
  .filter((p) => !p.data.draft && 
    p.data.pubDate.getFullYear() === year && 
    p.data.pubDate.getMonth() + 1 === monthNum)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout title={`아카이브: ${formatMonthKey(month!)}`} description={`${formatMonthKey(month!)} 글 목록`}>
  <div class="filtered-page">
    <p class="filter-label">월별 아카이브: <strong>{formatMonthKey(month!)}</strong></p>
    <ul class="post-list">
      {posts.map((post) => (
        <li class="post-item">
          <a href={getPostUrl(post.id)} class="post-title">{post.data.title}</a>
          <time datetime={post.data.pubDate.toISOString()} class="post-date">
            {post.data.pubDate.toLocaleDateString('ko-KR')}
          </time>
          <a href="/blog/">← 모든 글</a>
        </li>
      ))}
    </ul>
  </div>
</BaseLayout>
